---
title: "Tutorial: Artifact Repository"
author: "Lukasz A. Bartnik"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Tutorial: Artifact Repository}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(collapse = TRUE, comment = NA, prompt = FALSE, echo = TRUE)
```

```{r color, echo = FALSE}
options(crayon.enabled = TRUE)
knitr::knit_hooks$set(output = function(x, options){
  paste0(
    "<pre class=\"r-output\"><code>",
    fansi::sgr_to_html(htmltools::htmlEscape(x)),
    "</code></pre>"
  )
})

# https://stackoverflow.com/questions/23114654/knitr-output-hook-with-an-output-lines-option-that-works-like-echo-26
hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
   lines <- options$output.lines
   if (is.null(lines)) {
     return(hook_output(x, options))  # pass to default hook
   }
   x <- unlist(strsplit(x, "\n"))
   more <- function (x) utilities::cpaste(grey = paste("# ... with", x, "more line(s)"))
   if (length(lines)==1) {        # first n lines
     if (length(x) > lines) {
       # truncate the output, but add ...
       x <- c(head(x, lines), more(length(x)-lines))
     }
   } else {
     before <- abs(lines[1])
     after  <- abs(lines[length(lines)])
     x <- c(if (before>1) more(before) else NULL, 
            x[lines], 
            if (length(x)>after) more(after) else NULL
           )
   }
   # paste these lines together
   x <- paste(c(x, ""), collapse = "\n")
   hook_output(x, options)
 })
```

Plan (TODO):

  * Browse (general)
  * Find object/artifact
  * Search for artifact (lm, plot, etc.), then browse session from that point
  * Name an object (give a new name to an object)
  * Put an artifact in a collection
  * Export (explanation, history) to Rmd
  * Explain an object



# Produce objects - sample research project

Run a sample project generation.


```{r include=FALSE}
artifacts <- ui:::wrap(repository::filter(repository::sample_repository(), isTRUE(artifact)))
```

# Basic operations

## Project overview

We can look at R sessions recorded so far:

```{r}
artifacts$session
```

We can also see objects recorded in the repository:

```{r}
artifacts$name
```

Other keys are: `class`, `id` and `time`. Let's look at `time`:

```{r}
artifacts$time
```

## Exploring a recorded session

Specifying the session id queries for all artifacts created during
that R session.

```{r}
artifacts$session$`3abe4d2`
```


We can look at the history of evaluated commands:

```{r}
artifacts$session$`3abe4d2`$history
```


We can also look at the tree view of the artifacts, where edges of the
tree connect artifacts originating from one another.


```{r}
artifacts$session$`3abe4d2`$tree
```


## Searching for artifacts

We can limit the object selection by session identifier:

```{r}
artifacts$session$`3abe4d2`
```

Similarily, we can look at specific object creation time:

```{r eval=FALSE}
artifacts$time$since_yesterday
```

In both cases, we see a `filter()` expression added to the selection
query and at most the first three objects matching this query.


## Selecting an artifact

We can retrieve a specific artifact from the repository. Let's search for
artifacts whose name is `m`:

```{r}
artifacts$name$m
```

Since there is only one such artifact we can access it by adding `$value`
to the last query.

```{r, output.lines=8}
artifacts$name$m$value
```

If the name is not unique we can use artifact id.

```{r eval=FALSE}
artifacts$id$`57fbe755`$value
```

Unlike other tag names, `name` and `id` do not need to be used explicitly.
Thus, a shortcut version of these queries is:

```{r eval=FALSE}
artifacts$x$value
artifacts$`57fbe755`$value
```

If there is more than one object matching the query we can keep
narrowing the selection:

```{r eval=FALSE}
artifacts$name$y$class$lm$value
```

Similarly, we can construct a query where name or id is not specified
at all.

```{r eval=FALSE}
artifacts$time$yesterday$class$lm
```

Finally, you can use the bracket operator to access an arbitrary
object within a query result:

```{r eval=FALSE}
artifacts$time$yesterday$class$lm[[1]]
artifacts$time$yesterday$class$lm[[2]]
```
